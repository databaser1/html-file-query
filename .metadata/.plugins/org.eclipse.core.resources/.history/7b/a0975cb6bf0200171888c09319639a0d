var app = angular.module('app', []);

app.config(
  [
    '$controllerProvider', 
    function($controllerProvider) {
      $controllerProvider.allowGlobals();
    }
  ]
);

app.value('url', '');

app.controller(
  'htmlFileListController', 
  function($scope, $filter, $http, $sce, url) {
    $scope.selectedFileName = null;
    $scope.selectedFileBasename = null;
    $scope.selectedFileUrl = null;
    $scope.htmlText = null;

    var editor = ace.edit('code-editor');
    editor.setTheme("ace/theme/chrome");
    editor.getSession().setMode("ace/mode/html");
    editor.setOptions({
      readOnly: true,
  	  fontSize: '11pt'
   	});
    $scope.editor = editor;
    $scope.showFind = function () {
      $scope.editor.execCommand("find");
    };
    
    var browser = $('#html-browser');
    browser
    .on('load', function () {
      var element = $(this);
      var contents = element.contents();
      $scope.$apply(function () {
        $scope.htmlText = '<!DOCTYPE HTML>\n<!-- ' + $scope.selectedFileName + ' -->\n' + contents[0].body.innerHTML;
        $scope.editor.setValue($scope.htmlText);
        $scope.editor.gotoLine(0, 0);
        $scope.editor.renderer.scrollCursorIntoView({row: 0, column: 0}, 0);
      });
    })
    $scope.browser = browser;
        	
    $scope.selectFile = function (file) {
      $scope.selectedFileName = file.name;
      $scope.selectedFileBasename = file.basename;
      $scope.selectedFileUrl = $sce.trustAsResourceUrl(url + '/data/' + file.name);
    };
    
    $scope.query = function () {
      var outputHtml = Number($('#result-mode').val());
      var input = $('#query-input').find('textarea').val();
      var result = $scope.browser.contents().find(input);
      var output = [];
      for (var i = 0; i < result.length; i++) {
        if (outputHtml)
    	  output.push(result[i].innerHTML);
        else
      	  output.push(result[i].innerText);
      }
      var outputStr = JSON.stringify(output);
      outputStr = outputStr.replace(/\\n/g, ' ');
      $('#query-output').find('textarea').val(outputStr);
    };
    
    $scope.create = function () {
      var outputStr = $('#query-output').find('textarea').val();
      var output = JSON.parse(outputStr);
      var expression = new RegExp($('#query-regexp').find('textarea').val(), 'i');
      var elementStr;
      var extraction;
      var patternStr = $('#query-pattern').find('textarea').val();
      var tempResult;
      var queryFinal = '';
      if (output && output.length) {
   	    for (var i = 0; i < output.length; i++) {
          elementStr = output[i];  	    	  
    	  extraction = expression.exec(elementStr);
    	  tempResult = patternStr;
    	  tempResult = tempresult.replace('/\{basename\}/g', $scope.selectedFileBasename);
    	  tempResult = tempresult.replace('/\{0\}/g', extraction && extraction.length > 0 ? extraction[0] : '');
    	  tempResult = tempresult.replace('/\{1\}/g', extraction && extraction.length > 1 ? extraction[1] : '');
    	  tempResult = tempresult.replace('/\{2\}/g', extraction && extraction.length > 2 ? extraction[2] : '');
    	  tempResult = tempresult.replace('/\{3\}/g', extraction && extraction.length > 3 ? extraction[3] : '');
    	  tempResult = tempresult.replace('/\{4\}/g', extraction && extraction.length > 4 ? extraction[4] : '');
    	  tempResult = tempresult.replace('/\{5\}/g', extraction && extraction.length > 5 ? extraction[5] : '');
    	  tempResult = tempresult.replace('/\{6\}/g', extraction && extraction.length > 6 ? extraction[6] : '');
    	  tempResult = tempresult.replace('/\{7\}/g', extraction && extraction.length > 7 ? extraction[7] : '');
    	  tempResult = tempresult.replace('/\{8\}/g', extraction && extraction.length > 8 ? extraction[8] : '');
    	  tempResult = tempresult.replace('/\{9\}/g', extraction && extraction.length > 9 ? extraction[9] : '');
    	  queryFinal += tempResult + '&#10;';
   	    }
      }
      $('#query-final').find('textarea').val(queryFinal);

    };

    var options = {
      method: 'GET',
      url: url + '/list'
    };
    $http(options).then(
      function (success) {
	    $scope.list = $filter('orderBy')(success.data, 'name');
	    $scope.error = null;
      }, 
      function (error) {
	    $scope.list = null;  
        $scope.error = error.data; 
      }
    );
  }
);